{% extends "layout.html" %}
{% block content %}

<!-- Begin page content -->
<div class="container-fluid">
  <div class="row">
    <div class="col-md-2 position-fixed d-flex align-items-center justify-content-between custom-sidebar">
      <div class="row">
        <div class="col-12 text-center">
          <button class="btn btn-primary mb-2">Button 1</button>
        </div>
        <div class="col-12 text-center">
          <button class="btn btn-secondary mb-2">Button 2</button>
        </div>
        <!-- Add more buttons as needed -->
      </div>
      <!-- ... other sidebar content ... -->
    </div>
    <div class="col-md-10 offset-md-2">
      <!-- Your main content goes here -->
      <br>
      <br>
      <div id="list-group" class="list-group w-auto">
        <a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3">
          <img src="https://digital-practice.ams3.cdn.digitaloceanspaces.com/static%2Fapp%2Fimg%2Fopenai-logo.png" alt="twbs" width="32" height="32" class="rounded-circle flex-shrink-0">
          <div class="d-flex gap-2 w-100 justify-content-between">
            <div>
              <p class="mb-0 opacity-75">Hello, I am the chatbot for the AI4EIC Hackathon. How may I help you?</p>
            </div>
          </div>
        </a>
      </div>
      <div class="input-group mb-3">
        <textarea id="chat-input" class="form-control custom-control" oninput='resizeTextarea(this)'></textarea>
        <span id="gpt-button" class="input-group-asson btn btn-primary">Ask ChatGPT</span>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

<script>
  $(document).ready(function () {
    let isChatting = false;

    $("#gpt-button").attr("disabled", true);

    $("#gpt-button").click(function () {
      chat();
    });

    $("#chat-input").keypress(function (event) {
      if (event.which == 13) {
        event.preventDefault();
        chat();
      }
    });

    function download(data) {
      const blob = new Blob([data], { type: "application/x-python-code" });

      const href = URL.createObjectURL(blob);
      URL.revokeObjectURL(href);

      const a = Object.assign(document.createElement('a'), { href, style: "display:none", download: "program.py" });
      document.body.appendChild(a);

      a.click();
      URL.revokeObjectURL(href);
      a.remove();
    }

    document.getElementById('chat-input').addEventListener('input', resizeTextarea);

    function chat() {
      if (isChatting) {
        return; // Don't proceed if a chat request is already ongoing
      }

      var question = $("#chat-input").val();
      console.log("Test");
      $("#chat-input").focus();

      let html_data = '';
      html_data += `<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3">
        <img src="{{ url_for('static', filename='images/ai4eic-logo.png') }}" alt="twbs" width="32" height="32" class="rounded-circle flex-shrink-0">
        <div class="d-flex gap-2 w-100 justify-content-between">
          <div>
            <p class="mb-0 opacity-75">${question}</p>
          </div>
        </div>
      </a>`;
      $("#chat-input").val('');
      $("#list-group").append(html_data);
      resetTextarea();

      isChatting = true; // Set the flag to indicate the start of the chat request

      $.ajax({
        type: "POST",
        url: "/chat",
        data: { 'prompt': question },
        beforeSend: function () {
          $("#gpt-button").attr("disabled", true);
        },
        success: function (data) {
          let gpt_data = '';
          gpt_data += `
           <a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3">
            <img src="https://digital-practice.ams3.cdn.digitaloceanspaces.com/static%2Fapp%2Fimg%2Fopenai-logo.png" alt="twbs" width="32" height="32" class="rounded-circle flex-shrink-0">
            <div class="d-flex gap-2 w-100 justify-content-between">
                <div id="chat_box"></div>
            </div>
          </a>`;
          $("#list-group").append(gpt_data);
          generateCodeBox(data);
        },
        complete: function () {
          isChatting = false; // Reset the flag when the chat request is complete
          $("#gpt-button").attr("disabled", false);
        }
      });
    }
  });
</script>

<script>
    function generateCodeBox(data) {
      const chatContainer = document.createElement('div');
      chatContainer.classList.add("chat-box")
      for (let i = 0; i <= data.n_code - 1; i++) {
          var button = document.createElement("button");
          button.innerHTML = "Download Code";
          button.onclick = function() {
            alert("Button clicked!");
          };

          var codeBox = document.createElement('div');
          codeBox.classList.add('code-box')
          var codeContainer = document.createElement('div');
          var text_box = document.createElement('div');
          text_box.classList.add('text-box')
          codeBox.innerHTML = `<code class='code-box'>${data.code[i]}</code>`;
          text_box.innerHTML = `<div class='text-box'>${data.text[i]}</div>`;

          codeContainer.appendChild(codeBox);
          if (data.is_downloadable[i]) {
          codeContainer.appendChild(button);}

          chatContainer.appendChild(text_box);
          chatContainer.appendChild(codeContainer);
      }

      var text_box = document.createElement('div');
      text_box.innerHTML = `<div class='text-box'>${data.text[data.n_text - 1]}</div>`;
      chatContainer.appendChild(text_box);
      document.getElementById('chat_box').appendChild(chatContainer);
      $("#list-group").append(chatContainer);
    }
</script>

<script>
    function updateButtonTitles(titles) {
      var sidebar = document.getElementById('sidebar');
      var buttons = sidebar.querySelectorAll('button');

      buttons.forEach(function(button, index) {
        button.innerText = titles[index];
      });
    }
</script>

<script>
  function resizeTextarea() {
    const textarea = document.getElementById('chat-input');

    // Set the fixed height for the textarea
    const fixedHeight = 70; // You can adjust this value based on your design

    // Set the height to be fixed
    textarea.style.height = fixedHeight + 'px';

    // Reset the scroll position to the bottom
    textarea.scrollTop = textarea.scrollHeight;
  }
</script>

<script>
    function resetTextarea() {
      const textarea = document.getElementById('chat-input');
      textarea.style.height = ''; // Reset the height
    }
</script>
{% endblock content %}
